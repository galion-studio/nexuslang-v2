# GitHub Actions: Automated VPS Deployment
# Deploys GALION to VPS automatically when you push to main
# Setup: Add these secrets to GitHub repo settings
#   - VPS_HOST: 54.37.161.67
#   - VPS_USER: root (or deploy after first setup)
#   - VPS_SSH_KEY: Your private SSH key
#   - OPENAI_API_KEY: Your OpenAI key
#   - ELEVENLABS_API_KEY: Your ElevenLabs key

name: Deploy to VPS

on:
  push:
    branches: [ main ]
  workflow_dispatch:  # Manual trigger

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
      
      - name: Setup SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.VPS_SSH_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -H ${{ secrets.VPS_HOST }} >> ~/.ssh/known_hosts
      
      - name: Deploy to VPS
        env:
          VPS_HOST: ${{ secrets.VPS_HOST }}
          VPS_USER: ${{ secrets.VPS_USER }}
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          ELEVENLABS_API_KEY: ${{ secrets.ELEVENLABS_API_KEY }}
        run: |
          ssh $VPS_USER@$VPS_HOST << 'ENDSSH'
            set -e
            
            # Update code
            cd /home/deploy/galion || cd /root/galion
            git pull origin main
            
            # Update .env with API keys
            sed -i "s/OPENAI_API_KEY=.*/OPENAI_API_KEY=$OPENAI_API_KEY/" .env
            sed -i "s/ELEVENLABS_API_KEY=.*/ELEVENLABS_API_KEY=$ELEVENLABS_API_KEY/" .env
            
            # Deploy
            docker compose build
            docker compose up -d
            
            # Verify
            sleep 30
            docker compose ps
            
            echo "âœ… Deployment complete!"
          ENDSSH
      
      - name: Health Check
        run: |
          sleep 60
          curl -f http://${{ secrets.VPS_HOST }}:8001/health || echo "Health check pending..."
          curl -f http://${{ secrets.VPS_HOST }}:8003/health || echo "Health check pending..."
      
      - name: Notify Success
        if: success()
        run: echo "ðŸŽ‰ Deployment successful!"
      
      - name: Notify Failure
        if: failure()
        run: echo "âŒ Deployment failed - check logs"

