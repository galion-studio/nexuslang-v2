# ========================================
# PostgreSQL Configuration for GALION
# Optimized for 16GB RAM VPS
# ========================================

# -----------------------------
# Memory Settings
# -----------------------------
# 25% of RAM allocated to PostgreSQL (4GB of 16GB total)
shared_buffers = 2GB              # Shared memory for caching
effective_cache_size = 4GB        # OS + PG cache estimate
maintenance_work_mem = 512MB      # Memory for maintenance operations
work_mem = 16MB                   # Per-operation memory (sorting, hashing)
max_connections = 200             # Limit connections (use PgBouncer for pooling)

# -----------------------------
# Write-Ahead Log (WAL)
# -----------------------------
wal_buffers = 16MB
checkpoint_completion_target = 0.9  # Spread checkpoints over 90% of interval
max_wal_size = 2GB                  # Maximum WAL size before checkpoint
min_wal_size = 512MB                # Minimum WAL size to keep
wal_level = replica                 # Enable replication for future read replicas
max_wal_senders = 10                # Max replication connections
max_replication_slots = 10          # Max replication slots

# -----------------------------
# Query Planner
# -----------------------------
random_page_cost = 1.1              # SSD optimized (default 4.0 for HDD)
effective_io_concurrency = 200      # SSD parallelism (1 for HDD)
default_statistics_target = 100     # Statistics for query planner
shared_preload_libraries = 'pg_stat_statements'  # Query performance tracking

# -----------------------------
# Logging
# -----------------------------
log_min_duration_statement = 1000   # Log queries slower than 1 second
log_line_prefix = '%t [%p]: user=%u,db=%d,app=%a,client=%h '
log_checkpoints = on
log_connections = on
log_disconnections = on
log_duration = off
log_lock_waits = on                 # Log lock waits
log_statement = 'none'              # Log statements (none, ddl, mod, all)
log_temp_files = 0                  # Log all temp files

# -----------------------------
# Autovacuum (Automatic maintenance)
# -----------------------------
autovacuum = on
autovacuum_max_workers = 3
autovacuum_naptime = 1min          # Time between autovacuum runs

# -----------------------------
# Connection Settings
# -----------------------------
listen_addresses = '*'              # Listen on all interfaces
max_connections = 200               # Maximum concurrent connections
superuser_reserved_connections = 3  # Reserved for superuser

# -----------------------------
# Performance & Tuning
# -----------------------------
# Parallel query execution
max_parallel_workers_per_gather = 2
max_parallel_workers = 4
max_worker_processes = 8

# Background writer
bgwriter_delay = 200ms
bgwriter_lru_maxpages = 100
bgwriter_lru_multiplier = 2.0

# -----------------------------
# Client Connection Defaults
# -----------------------------
timezone = 'UTC'
lc_messages = 'en_US.utf8'
lc_monetary = 'en_US.utf8'
lc_numeric = 'en_US.utf8'
lc_time = 'en_US.utf8'
default_text_search_config = 'pg_catalog.english'

# -----------------------------
# Lock Management
# -----------------------------
deadlock_timeout = 1s
max_locks_per_transaction = 64

# -----------------------------
# Statement Timeout
# -----------------------------
# Prevent long-running queries from blocking
statement_timeout = 300000          # 5 minutes (in milliseconds)
lock_timeout = 30000                # 30 seconds

# -----------------------------
# Extensions
# -----------------------------
# These are loaded at server start
# pg_stat_statements for query performance monitoring

