version: '3.8'

services:
  # PostgreSQL test database
  postgres-test:
    image: postgres:15-alpine
    container_name: galion_postgres_test
    environment:
      POSTGRES_DB: galion_test
      POSTGRES_USER: galion
      POSTGRES_PASSWORD: galion_test_password
      POSTGRES_INITDB_ARGS: "--encoding=UTF-8"
    ports:
      - "5433:5432"
    volumes:
      - postgres_test_data:/var/lib/postgresql/data
      - ./runpod/init-db.sql:/docker-entrypoint-initdb.d/init-db.sql
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U galion -d galion_test"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - galion_test_network

  # Redis test cache
  redis-test:
    image: redis:7-alpine
    container_name: galion_redis_test
    ports:
      - "6380:6379"
    command: redis-server --appendonly yes
    volumes:
      - redis_test_data:/data
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - galion_test_network

  # Galion backend API (test instance)
  backend-test:
    build:
      context: .
      dockerfile: Dockerfile
      target: development
    container_name: galion_backend_test
    environment:
      GALION_ENV: test
      DATABASE_URL: postgresql://galion:galion_test_password@postgres-test:5432/galion_test
      REDIS_URL: redis://redis-test:6379/1
      SECRET_KEY: test_secret_key_for_testing_only
      CORS_ORIGINS: ["http://localhost:3000", "http://localhost:3001"]
      LOG_LEVEL: WARNING
      MAX_CONCURRENT_AGENTS: 5
      TASK_TIMEOUT: 300
      API_RATE_LIMIT: 100/minute
    ports:
      - "8011:8010"  # Different port to avoid conflicts
    depends_on:
      postgres-test:
        condition: service_healthy
      redis-test:
        condition: service_healthy
    volumes:
      - ./v2:/app/v2:ro
      - ./tests:/app/tests:ro
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8010/health"]
      interval: 30s
      timeout: 10s
      retries: 3
    networks:
      - galion_test_network
    command: >
      sh -c "
        echo 'Waiting for database...' &&
        while ! nc -z postgres-test 5432; do sleep 1; done &&
        echo 'Database ready, starting server...' &&
        python -m uvicorn v2.backend.main:app --host 0.0.0.0 --port 8010 --reload
      "

  # Admin dashboard (test instance)
  admin-dashboard-test:
    build:
      context: ./admin-dashboard
      dockerfile: Dockerfile
      target: development
    container_name: galion_admin_test
    environment:
      NEXT_PUBLIC_API_URL: http://backend-test:8010
      NEXT_PUBLIC_WS_URL: ws://backend-test:8010
      NEXT_PUBLIC_ENVIRONMENT: test
      NODE_ENV: development
    ports:
      - "3001:3000"  # Different port to avoid conflicts
    depends_on:
      - backend-test
    volumes:
      - ./admin-dashboard:/app
      - /app/node_modules
      - /app/.next
    networks:
      - galion_test_network
    command: npm run dev

  # Test runner service
  test-runner:
    build:
      context: .
      dockerfile: Dockerfile.test
    container_name: galion_test_runner
    environment:
      GALION_ENV: test
      DATABASE_URL: postgresql://galion:galion_test_password@postgres-test:5432/galion_test
      REDIS_URL: redis://redis-test:6379/1
      TEST_API_URL: http://backend-test:8010
    depends_on:
      backend-test:
        condition: service_healthy
      postgres-test:
        condition: service_healthy
      redis-test:
        condition: service_healthy
    volumes:
      - ./v2:/app/v2:ro
      - ./tests:/app/tests:ro
      - ./htmlcov:/app/htmlcov
    working_dir: /app
    networks:
      - galion_test_network
    command: >
      sh -c "
        echo 'Waiting for services...' &&
        sleep 10 &&
        echo 'Running tests...' &&
        pytest tests/ -v --tb=short --cov=v2 --cov-report=html --cov-report=xml --maxfail=5
      "

  # Performance monitoring (optional)
  monitoring-test:
    image: prom/prometheus:latest
    container_name: galion_monitoring_test
    ports:
      - "9091:9090"
    volumes:
      - ./monitoring/prometheus.yml:/etc/prometheus/prometheus.yml:ro
    command:
      - '--config.file=/etc/prometheus/prometheus.yml'
      - '--storage.tsdb.path=/prometheus'
      - '--web.console.libraries=/etc/prometheus/console_libraries'
      - '--web.console.templates=/etc/prometheus/consoles'
      - '--storage.tsdb.retention.time=200h'
      - '--web.enable-lifecycle'
    networks:
      - galion_test_network

  # Grafana for test metrics visualization (optional)
  grafana-test:
    image: grafana/grafana:latest
    container_name: galion_grafana_test
    environment:
      GF_SECURITY_ADMIN_PASSWORD: admin
      GF_USERS_ALLOW_SIGN_UP: "false"
    ports:
      - "3002:3000"
    volumes:
      - grafana_test_data:/var/lib/grafana
      - ./monitoring/grafana/provisioning:/etc/grafana/provisioning:ro
      - ./monitoring/grafana/dashboards:/var/lib/grafana/dashboards:ro
    depends_on:
      - monitoring-test
    networks:
      - galion_test_network

volumes:
  postgres_test_data:
    driver: local
  redis_test_data:
    driver: local
  grafana_test_data:
    driver: local

networks:
  galion_test_network:
    driver: bridge
    ipam:
      config:
        - subnet: 172.20.0.0/16
