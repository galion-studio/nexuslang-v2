<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üéôÔ∏è Nexus Voice - Talk to JARVIS</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Oxygen', 'Ubuntu', 'Cantarell', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }

        .container {
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            max-width: 600px;
            width: 100%;
            padding: 40px;
        }

        h1 {
            text-align: center;
            color: #667eea;
            margin-bottom: 10px;
            font-size: 2em;
        }

        .tagline {
            text-align: center;
            color: #666;
            margin-bottom: 30px;
            font-size: 0.9em;
        }

        .voice-button {
            width: 200px;
            height: 200px;
            border-radius: 50%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border: none;
            margin: 0 auto 30px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 10px 30px rgba(102, 126, 234, 0.4);
        }

        .voice-button:hover {
            transform: scale(1.05);
            box-shadow: 0 15px 40px rgba(102, 126, 234, 0.6);
        }

        .voice-button:active {
            transform: scale(0.95);
        }

        .voice-button.listening {
            animation: pulse 1.5s infinite;
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1); }
        }

        .mic-icon {
            font-size: 4em;
            margin-bottom: 10px;
        }

        .button-text {
            color: white;
            font-weight: 600;
            font-size: 1.1em;
        }

        .status {
            text-align: center;
            margin-bottom: 20px;
            padding: 15px;
            border-radius: 10px;
            background: #f5f7fa;
            min-height: 60px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .status-text {
            color: #666;
            font-size: 1em;
        }

        .status.listening { background: #e3f2fd; color: #1976d2; }
        .status.processing { background: #fff3e0; color: #f57c00; }
        .status.speaking { background: #e8f5e9; color: #388e3c; }
        .status.error { background: #ffebee; color: #c62828; }

        .transcript {
            background: #f5f7fa;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
            min-height: 100px;
        }

        .transcript-label {
            font-weight: 600;
            color: #667eea;
            margin-bottom: 10px;
        }

        .transcript-text {
            color: #333;
            line-height: 1.6;
        }

        .response {
            background: #667eea;
            color: white;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
            min-height: 100px;
        }

        .response-label {
            font-weight: 600;
            margin-bottom: 10px;
            opacity: 0.9;
        }

        .response-text {
            line-height: 1.6;
        }

        .suggestions {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 10px;
            margin-top: 20px;
        }

        .suggestion-btn {
            padding: 12px 20px;
            border: 2px solid #667eea;
            background: white;
            color: #667eea;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 0.9em;
        }

        .suggestion-btn:hover {
            background: #667eea;
            color: white;
        }

        .login-section {
            background: #fff3e0;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 20px;
            text-align: center;
        }

        .login-input {
            width: 100%;
            padding: 10px;
            margin: 5px 0;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 1em;
        }

        .login-btn {
            background: #667eea;
            color: white;
            border: none;
            padding: 12px 30px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1em;
            margin-top: 10px;
        }

        .login-btn:hover {
            background: #764ba2;
        }

        .instructions {
            background: #e3f2fd;
            border-radius: 10px;
            padding: 15px;
            margin-top: 20px;
            font-size: 0.9em;
            color: #1976d2;
        }

        .instructions ul {
            margin-left: 20px;
            margin-top: 10px;
        }

        .waveform {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 3px;
            margin-top: 10px;
        }

        .bar {
            width: 4px;
            height: 20px;
            background: white;
            border-radius: 2px;
            animation: wave 1s infinite ease-in-out;
        }

        .bar:nth-child(1) { animation-delay: 0s; }
        .bar:nth-child(2) { animation-delay: 0.1s; }
        .bar:nth-child(3) { animation-delay: 0.2s; }
        .bar:nth-child(4) { animation-delay: 0.3s; }
        .bar:nth-child(5) { animation-delay: 0.4s; }

        @keyframes wave {
            0%, 100% { height: 20px; }
            50% { height: 40px; }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üéôÔ∏è Nexus Voice</h1>
        <p class="tagline">Talk to Nexus like you talk to JARVIS</p>

        <div id="loginSection" class="login-section">
            <p><strong>üîê Login Required</strong></p>
            <input type="email" id="emailInput" class="login-input" placeholder="Email">
            <input type="password" id="passwordInput" class="login-input" placeholder="Password">
            <button onclick="login()" class="login-btn">Login</button>
        </div>

        <button id="voiceButton" class="voice-button" onclick="toggleVoice()" disabled>
            <div class="mic-icon">üé§</div>
            <div class="button-text" id="buttonText">Hold to Speak</div>
            <div class="waveform" id="waveform" style="display: none;">
                <div class="bar"></div>
                <div class="bar"></div>
                <div class="bar"></div>
                <div class="bar"></div>
                <div class="bar"></div>
            </div>
        </button>

        <div class="status" id="status">
            <div class="status-text">üëÜ Login and press the button to speak</div>
        </div>

        <div class="transcript">
            <div class="transcript-label">üí¨ You Said:</div>
            <div class="transcript-text" id="transcript">...</div>
        </div>

        <div class="response">
            <div class="response-label">ü§ñ Nexus Says:</div>
            <div class="response-text" id="response">...</div>
        </div>

        <div class="suggestions">
            <button class="suggestion-btn" onclick="sendTextCommand('show my profile')">üë§ Show Profile</button>
            <button class="suggestion-btn" onclick="sendTextCommand('help')">‚ùì Help</button>
            <button class="suggestion-btn" onclick="sendTextCommand('system status')">üìä Status</button>
            <button class="suggestion-btn" onclick="sendTextCommand('search for AI')">üîç Search</button>
        </div>

        <div class="instructions">
            <strong>üìö How to Use:</strong>
            <ul>
                <li>Login with your Nexus Core credentials</li>
                <li>Hold the button and speak your command</li>
                <li>Release when done speaking</li>
                <li>Wait for voice response</li>
                <li>Or click suggestion buttons for quick commands</li>
            </ul>
        </div>
    </div>

    <script>
        let jwtToken = null;
        let ws = null;
        let mediaRecorder = null;
        let audioChunks = [];
        let isRecording = false;

        const statusEl = document.getElementById('status');
        const transcriptEl = document.getElementById('transcript');
        const responseEl = document.getElementById('response');
        const buttonTextEl = document.getElementById('buttonText');
        const waveformEl = document.getElementById('waveform');
        const voiceButton = document.getElementById('voiceButton');

        function setStatus(text, className = '') {
            statusEl.innerHTML = `<div class="status-text">${text}</div>`;
            statusEl.className = 'status ' + className;
        }

        async function login() {
            const email = document.getElementById('emailInput').value;
            const password = document.getElementById('passwordInput').value;

            if (!email || !password) {
                alert('Please enter email and password');
                return;
            }

            setStatus('üîê Logging in...', 'processing');

            try {
                const response = await fetch('http://localhost:8080/api/v1/auth/login', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email, password })
                });

                if (!response.ok) {
                    throw new Error('Login failed');
                }

                const data = await response.json();
                jwtToken = data.access_token;

                document.getElementById('loginSection').style.display = 'none';
                voiceButton.disabled = false;
                setStatus('‚úÖ Connected! Press and hold to speak', 'listening');

                connectWebSocket();
            } catch (error) {
                setStatus('‚ùå Login failed: ' + error.message, 'error');
            }
        }

        function connectWebSocket() {
            const wsUrl = `ws://localhost:8003/api/v1/voice/stream?token=${jwtToken}`;
            ws = new WebSocket(wsUrl);

            ws.onopen = () => {
                console.log('WebSocket connected');
                setStatus('‚úÖ Ready! Press and hold to speak', 'listening');
            };

            ws.onmessage = (event) => {
                if (typeof event.data === 'string') {
                    const message = JSON.parse(event.data);
                    handleWebSocketMessage(message);
                } else {
                    // Binary audio data
                    playAudio(event.data);
                }
            };

            ws.onerror = (error) => {
                console.error('WebSocket error:', error);
                setStatus('‚ùå Connection error', 'error');
            };

            ws.onclose = () => {
                console.log('WebSocket disconnected');
                setStatus('üîå Disconnected', 'error');
            };
        }

        function handleWebSocketMessage(message) {
            console.log('Message:', message);

            switch (message.type) {
                case 'connected':
                    setStatus('‚úÖ ' + message.message, 'listening');
                    break;
                case 'receiving':
                    setStatus(`üì° Receiving audio (${message.buffer_size} bytes)`, 'listening');
                    break;
                case 'status':
                    setStatus('‚öôÔ∏è ' + message.message, 'processing');
                    break;
                case 'transcript':
                    transcriptEl.textContent = message.text;
                    break;
                case 'intent':
                    setStatus(`üß† Intent: ${message.intent} (${Math.round(message.confidence * 100)}%)`, 'processing');
                    break;
                case 'response':
                    responseEl.textContent = message.text;
                    break;
                case 'audio_start':
                    setStatus('üîä Playing voice response...', 'speaking');
                    waveformEl.style.display = 'flex';
                    break;
                case 'audio_complete':
                    setStatus('‚úÖ Done! Press to speak again', 'listening');
                    waveformEl.style.display = 'none';
                    break;
                case 'error':
                    setStatus('‚ùå Error: ' + message.message, 'error');
                    break;
            }
        }

        async function toggleVoice() {
            if (isRecording) {
                stopRecording();
            } else {
                startRecording();
            }
        }

        async function startRecording() {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                mediaRecorder = new MediaRecorder(stream);
                audioChunks = [];

                mediaRecorder.ondataavailable = (event) => {
                    audioChunks.push(event.data);
                };

                mediaRecorder.onstop = async () => {
                    const audioBlob = new Blob(audioChunks, { type: 'audio/webm' });
                    await sendAudio(audioBlob);
                };

                mediaRecorder.start();
                isRecording = true;
                voiceButton.classList.add('listening');
                buttonTextEl.textContent = 'Recording...';
                waveformEl.style.display = 'flex';
                setStatus('üé§ Listening... Release when done', 'listening');
            } catch (error) {
                setStatus('‚ùå Microphone error: ' + error.message, 'error');
            }
        }

        function stopRecording() {
            if (mediaRecorder && isRecording) {
                mediaRecorder.stop();
                mediaRecorder.stream.getTracks().forEach(track => track.stop());
                isRecording = false;
                voiceButton.classList.remove('listening');
                buttonTextEl.textContent = 'Hold to Speak';
                waveformEl.style.display = 'none';
                setStatus('‚öôÔ∏è Processing your voice...', 'processing');
            }
        }

        async function sendAudio(audioBlob) {
            try {
                const arrayBuffer = await audioBlob.arrayBuffer();
                
                // Send audio complete message
                ws.send(JSON.stringify({
                    type: 'audio_complete',
                    format: 'webm'
                }));
                
                // Send audio data
                ws.send(arrayBuffer);
            } catch (error) {
                setStatus('‚ùå Error sending audio: ' + error.message, 'error');
            }
        }

        function sendTextCommand(text) {
            if (!ws || ws.readyState !== WebSocket.OPEN) {
                setStatus('‚ùå Not connected. Please login.', 'error');
                return;
            }

            transcriptEl.textContent = text;
            setStatus('‚öôÔ∏è Processing...', 'processing');

            ws.send(JSON.stringify({
                type: 'text_fallback',
                text: text
            }));
        }

        function playAudio(audioData) {
            const audioBlob = new Blob([audioData], { type: 'audio/mpeg' });
            const audioUrl = URL.createObjectURL(audioBlob);
            const audio = new Audio(audioUrl);
            
            audio.play();
            
            audio.onended = () => {
                URL.revokeObjectURL(audioUrl);
                setStatus('‚úÖ Done! Press to speak again', 'listening');
                waveformEl.style.display = 'none';
            };
        }

        // Keyboard shortcut: Space bar
        let spacePressed = false;
        document.addEventListener('keydown', (e) => {
            if (e.code === 'Space' && !spacePressed && !voiceButton.disabled) {
                e.preventDefault();
                spacePressed = true;
                if (!isRecording) {
                    startRecording();
                }
            }
        });

        document.addEventListener('keyup', (e) => {
            if (e.code === 'Space' && spacePressed) {
                e.preventDefault();
                spacePressed = false;
                if (isRecording) {
                    stopRecording();
                }
            }
        });
    </script>
</body>
</html>

