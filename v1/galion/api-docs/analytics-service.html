<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Analytics Service - Nexus Core</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        .container { max-width: 1200px; margin: 0 auto; }
        .header {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 40px;
            margin-bottom: 30px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        }
        .header h1 {
            font-size: 2.5em;
            color: #2d3748;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 15px;
        }
        .header .subtitle { color: #718096; font-size: 1.1em; margin-bottom: 20px; }
        .badge {
            display: inline-block;
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 0.85em;
            font-weight: 600;
            background: #c6f6d5;
            color: #22543d;
            margin-right: 10px;
        }
        .content-card {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 30px;
            margin-bottom: 20px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
        }
        .content-card h2 {
            color: #2d3748;
            font-size: 1.8em;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 3px solid #667eea;
        }
        .content-card h3 { color: #4a5568; font-size: 1.3em; margin-top: 25px; margin-bottom: 15px; }
        .description { margin-top: 10px; color: #4a5568; line-height: 1.6; }
        pre {
            background: #2d3748;
            color: #e2e8f0;
            padding: 20px;
            border-radius: 8px;
            overflow-x: auto;
            margin: 15px 0;
            font-family: 'Courier New', monospace;
            font-size: 0.9em;
        }
        code {
            font-family: 'Courier New', monospace;
            background: #edf2f7;
            padding: 2px 6px;
            border-radius: 3px;
            color: #e53e3e;
        }
        .feature-list { list-style: none; padding: 0; }
        .feature-list li {
            padding: 10px 0;
            padding-left: 30px;
            position: relative;
        }
        .feature-list li:before {
            content: "‚úì";
            position: absolute;
            left: 0;
            color: #48bb78;
            font-weight: bold;
            font-size: 1.2em;
        }
        .nav-links { display: flex; gap: 15px; flex-wrap: wrap; }
        .nav-link {
            display: inline-flex;
            align-items: center;
            gap: 5px;
            padding: 10px 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            text-decoration: none;
            border-radius: 8px;
            font-weight: 600;
            transition: all 0.3s ease;
        }
        .nav-link:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }
        .nav-link.secondary { background: #cbd5e0; color: #2d3748; }
        table { width: 100%; border-collapse: collapse; margin: 15px 0; }
        th, td { padding: 12px; text-align: left; border-bottom: 1px solid #e2e8f0; }
        th { background: #edf2f7; font-weight: 600; color: #2d3748; }
        .event-card {
            background: #f7fafc;
            border-left: 4px solid #ed8936;
            padding: 20px;
            margin: 20px 0;
            border-radius: 8px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üìä Analytics Service</h1>
            <p class="subtitle">Real-time event processing and analytics with Kafka and Prometheus</p>
            <div>
                <span class="badge">Port: 9090</span>
                <span class="badge">Go 1.21</span>
                <span class="badge">Kafka Consumer</span>
            </div>
            <div class="nav-links" style="margin-top: 20px;">
                <a href="../nexus-status.html" class="nav-link">‚Üê Back to Status</a>
                <a href="http://localhost:9090/metrics" class="nav-link" target="_blank">üìà Prometheus Metrics</a>
                <a href="../docs/ANALYTICS_SERVICE.md" class="nav-link secondary">üìÑ Service Details</a>
            </div>
        </div>

        <div class="content-card">
            <h2>üéØ Overview</h2>
            <p class="description">
                The Analytics Service consumes events from Kafka, processes them in real-time, and stores them in PostgreSQL
                for analysis. It provides Prometheus metrics for monitoring system-wide activity and user behavior patterns.
            </p>
            
            <h3>Key Features</h3>
            <ul class="feature-list">
                <li>Real-time event processing from Kafka</li>
                <li>Event storage in PostgreSQL for historical analysis</li>
                <li>Prometheus metrics export for monitoring</li>
                <li>Automatic retry and error handling</li>
                <li>High-throughput event processing (1000+ events/sec)</li>
                <li>Event deduplication and validation</li>
            </ul>
        </div>

        <div class="content-card">
            <h2>üì• Consumed Events</h2>
            <p class="description">
                The service consumes events from the <code>user-events</code> Kafka topic. All services publish events to this topic.
            </p>

            <div class="event-card">
                <h3 style="margin-top: 0; color: #2d3748;">user_registered</h3>
                <p class="description">Published when a new user registers</p>
<pre>{
  "event_type": "user_registered",
  "user_id": "550e8400-e29b-41d4-a716-446655440000",
  "service": "auth-service",
  "timestamp": "2024-11-09T10:30:00Z",
  "data": {
    "email": "user@example.com",
    "name": "John Doe",
    "registration_method": "email"
  }
}</pre>
            </div>

            <div class="event-card">
                <h3 style="margin-top: 0; color: #2d3748;">user_login</h3>
                <p class="description">Published on successful login</p>
<pre>{
  "event_type": "user_login",
  "user_id": "550e8400-e29b-41d4-a716-446655440000",
  "service": "auth-service",
  "timestamp": "2024-11-09T15:45:00Z",
  "data": {
    "ip_address": "192.168.1.1",
    "user_agent": "Mozilla/5.0...",
    "2fa_used": true
  }
}</pre>
            </div>

            <div class="event-card">
                <h3 style="margin-top: 0; color: #2d3748;">profile_updated</h3>
                <p class="description">Published when user updates profile</p>
<pre>{
  "event_type": "profile_updated",
  "user_id": "550e8400-e29b-41d4-a716-446655440000",
  "service": "user-service",
  "timestamp": "2024-11-09T16:00:00Z",
  "data": {
    "fields_updated": ["name"],
    "previous_values": {"name": "John Doe"},
    "new_values": {"name": "John Smith"}
  }
}</pre>
            </div>

            <div class="event-card">
                <h3 style="margin-top: 0; color: #2d3748;">profile_viewed</h3>
                <p class="description">Published when a user views a profile</p>
<pre>{
  "event_type": "profile_viewed",
  "user_id": "550e8400-e29b-41d4-a716-446655440000",
  "service": "user-service",
  "timestamp": "2024-11-09T16:05:00Z",
  "data": {
    "viewed_user_id": "660f9511-f39c-42e5-b827-557766551111",
    "view_duration_seconds": 15
  }
}</pre>
            </div>

            <div class="event-card">
                <h3 style="margin-top: 0; color: #2d3748;">user_search</h3>
                <p class="description">Published when user performs a search</p>
<pre>{
  "event_type": "user_search",
  "user_id": "550e8400-e29b-41d4-a716-446655440000",
  "service": "user-service",
  "timestamp": "2024-11-09T16:10:00Z",
  "data": {
    "query": "john",
    "filters": {"role": "user"},
    "results_count": 5
  }
}</pre>
            </div>
        </div>

        <div class="content-card">
            <h2>üìà Prometheus Metrics</h2>
            <p class="description">
                Access metrics at: <code>http://localhost:9090/metrics</code>
            </p>

            <h3>Available Metrics</h3>
            <table>
                <tr>
                    <th>Metric</th>
                    <th>Type</th>
                    <th>Description</th>
                </tr>
                <tr>
                    <td><code>events_processed_total</code></td>
                    <td>Counter</td>
                    <td>Total events processed (by type and service)</td>
                </tr>
                <tr>
                    <td><code>events_stored_total</code></td>
                    <td>Gauge</td>
                    <td>Total events in database</td>
                </tr>
                <tr>
                    <td><code>processing_errors_total</code></td>
                    <td>Counter</td>
                    <td>Total processing errors (by type and reason)</td>
                </tr>
                <tr>
                    <td><code>event_processing_duration_seconds</code></td>
                    <td>Histogram</td>
                    <td>Time to process an event</td>
                </tr>
                <tr>
                    <td><code>kafka_consumer_lag</code></td>
                    <td>Gauge</td>
                    <td>Consumer lag (events behind)</td>
                </tr>
            </table>

            <h3>Example Metrics Output</h3>
<pre># HELP events_processed_total Total number of events processed
# TYPE events_processed_total counter
events_processed_total{event_type="user_registered",service="auth-service"} 150
events_processed_total{event_type="user_login",service="auth-service"} 450
events_processed_total{event_type="profile_updated",service="user-service"} 78

# HELP events_stored_total Total number of events in database
# TYPE events_stored_total gauge
events_stored_total 678

# HELP processing_errors_total Total processing errors
# TYPE processing_errors_total counter
processing_errors_total{event_type="user_login",reason="validation_error"} 3</pre>
        </div>

        <div class="content-card">
            <h2>üóÑÔ∏è Data Storage</h2>
            <p class="description">Events are stored in the <code>events</code> table in PostgreSQL:</p>

            <h3>Table Schema</h3>
<pre>CREATE TABLE events (
    id SERIAL PRIMARY KEY,
    event_type VARCHAR(100) NOT NULL,
    user_id UUID NOT NULL,
    service VARCHAR(100) NOT NULL,
    timestamp TIMESTAMPTZ NOT NULL,
    data JSONB NOT NULL,
    created_at TIMESTAMPTZ DEFAULT NOW()
);

-- Indexes for performance
CREATE INDEX idx_events_user_id ON events(user_id);
CREATE INDEX idx_events_event_type ON events(event_type);
CREATE INDEX idx_events_timestamp ON events(timestamp);
CREATE INDEX idx_events_service ON events(service);</pre>

            <h3>Example Queries</h3>
<pre>-- Get all events for a user
SELECT * FROM events 
WHERE user_id = '550e8400-e29b-41d4-a716-446655440000' 
ORDER BY timestamp DESC;

-- Count events by type
SELECT event_type, COUNT(*) 
FROM events 
GROUP BY event_type;

-- Get recent logins
SELECT * FROM events 
WHERE event_type = 'user_login' 
AND timestamp > NOW() - INTERVAL '24 hours';</pre>
        </div>

        <div class="content-card">
            <h2>‚öôÔ∏è Configuration</h2>
            <h3>Environment Variables</h3>
            <table>
                <tr>
                    <th>Variable</th>
                    <th>Description</th>
                    <th>Default</th>
                </tr>
                <tr>
                    <td><code>METRICS_PORT</code></td>
                    <td>Prometheus metrics port</td>
                    <td>9090</td>
                </tr>
                <tr>
                    <td><code>KAFKA_BROKERS</code></td>
                    <td>Kafka broker addresses</td>
                    <td>localhost:9092</td>
                </tr>
                <tr>
                    <td><code>KAFKA_TOPIC</code></td>
                    <td>Topic to consume</td>
                    <td>user-events</td>
                </tr>
                <tr>
                    <td><code>KAFKA_GROUP_ID</code></td>
                    <td>Consumer group ID</td>
                    <td>analytics-service</td>
                </tr>
                <tr>
                    <td><code>DATABASE_URL</code></td>
                    <td>PostgreSQL connection string</td>
                    <td>Required</td>
                </tr>
            </table>
        </div>

        <div class="content-card">
            <h2>üîç Health Check</h2>
<pre>GET /health

Response:
{
  "status": "healthy",
  "service": "analytics-service"
}</pre>
        </div>

        <div class="content-card">
            <h2>üìä Performance</h2>
            <table>
                <tr>
                    <th>Metric</th>
                    <th>Value</th>
                </tr>
                <tr>
                    <td>Event Processing Throughput</td>
                    <td>1000+ events/second</td>
                </tr>
                <tr>
                    <td>Average Processing Latency</td>
                    <td>&lt; 10ms per event</td>
                </tr>
                <tr>
                    <td>Kafka Consumer Lag</td>
                    <td>Typically 0 (real-time)</td>
                </tr>
                <tr>
                    <td>Database Write Batch Size</td>
                    <td>1 (single event per write)</td>
                </tr>
                <tr>
                    <td>Memory Usage</td>
                    <td>~50MB under normal load</td>
                </tr>
            </table>
        </div>

        <div class="content-card">
            <h2>üîß Integration with Grafana</h2>
            <p class="description">
                The Analytics Service exports metrics that can be visualized in Grafana. Pre-configured dashboards include:
            </p>
            <ul class="feature-list">
                <li>Event Processing Overview (events/sec, errors, latency)</li>
                <li>User Activity Heatmap (registrations, logins over time)</li>
                <li>Service Health (consumer lag, database connections)</li>
                <li>Event Type Distribution (pie chart of event types)</li>
            </ul>
            <p class="description" style="margin-top: 15px;">
                Access Grafana at: <a href="http://localhost:3000" target="_blank" style="color: #667eea;">http://localhost:3000</a>
            </p>
        </div>
    </div>
</body>
</html>

