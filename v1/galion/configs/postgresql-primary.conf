# ========================================
# PostgreSQL Primary Server Configuration
# For use when scaling to multiple database servers
# ========================================

# Include base configuration
include '/etc/postgresql/postgresql.conf'

# -----------------------------
# Replication Settings (Primary)
# -----------------------------

# WAL level must be 'replica' or 'logical' for replication
wal_level = replica

# Maximum number of replication connections
max_wal_senders = 10

# Maximum number of replication slots
max_replication_slots = 10

# Maximum size of WAL kept for replication
wal_keep_size = 2GB

# Synchronous replication (waits for replica to confirm)
# Options: off, local, remote_write, remote_apply, on
# For high availability: 'remote_write'
# For maximum durability: 'remote_apply'
# For performance: 'off'
synchronous_commit = on

# List of standby servers for synchronous replication
# Format: 'FIRST num (standby_name1, standby_name2, ...)'
# synchronous_standby_names = 'FIRST 1 (replica1)'  # Uncomment when replica is added

# Archive WAL files for backup
archive_mode = on
archive_command = 'test ! -f /backups/wal_archive/%f && cp %p /backups/wal_archive/%f'
archive_timeout = 300  # Force archive every 5 minutes

# -----------------------------
# Hot Standby Settings
# -----------------------------

# Allow read queries on standby (doesn't affect primary)
hot_standby = on

# Maximum delay before canceling queries when applying WAL
max_standby_streaming_delay = 30s
max_standby_archive_delay = 60s

# -----------------------------
# Connection Settings for Replication
# -----------------------------

# Allow connections from replica servers
# Configure in pg_hba.conf:
# host replication galion 10.0.0.0/8 md5

# -----------------------------
# Monitoring
# -----------------------------

# Track replication lag
track_commit_timestamp = on

# Log replication events
log_replication_commands = on

